{% extends "base.html" %}

{% block title %}Chat with AI - HomeMade GPT{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="bi bi-chat-dots-fill feature-icon d-block"></i>
            Chat with Your AI
        </h1>
        <p class="text-center text-muted mb-5">
            Select a trained model and start chatting! Adjust creativity and response length as needed.
        </p>
    </div>
</div>

{% if models %}
<div class="row">
    <!-- Model Selection Sidebar -->
    <div class="col-lg-3 mb-4">
        <div class="card sticky-top" style="top: 100px;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-cpu"></i> Select Model
                </h6>
            </div>
            <div class="card-body">
                <select class="form-select mb-3" id="modelSelect">
                    <option value="">Choose a model...</option>
                    {% for model in models %}
                    <option value="{{ model.path }}" 
                            {% if request.args.get('model') == model.file %}selected{% endif %}>
                        {{ model.name }} ({{ model.params }})
                    </option>
                    {% endfor %}
                </select>
                
                <div id="modelInfo" class="alert alert-info d-none">
                    <small>
                        <strong>Selected Model:</strong><br>
                        <span id="modelName">-</span><br>
                        <span id="modelDetails">-</span>
                    </small>
                </div>
                
                <!-- Generation Settings -->
                <h6 class="mt-3 mb-2">Generation Settings</h6>
                
                <div class="mb-3">
                    <label for="temperature" class="form-label">
                        Creativity: <span id="tempValue">0.8</span>
                    </label>
                    <input type="range" class="form-range" id="temperature" 
                           min="0.1" max="2.0" step="0.1" value="0.8">
                    <small class="text-muted">Lower = more focused, Higher = more creative</small>
                </div>
                
                <div class="mb-3">
                    <label for="maxLength" class="form-label">
                        Response Length: <span id="lengthValue">200</span>
                    </label>
                    <input type="range" class="form-range" id="maxLength" 
                           min="50" max="500" step="25" value="200">
                </div>
                
                <!-- Chat Controls -->
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-outline-warning btn-sm" onclick="clearChat()">
                        <i class="bi bi-trash"></i> Clear Chat
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="exportChat()">
                        <i class="bi bi-download"></i> Export Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Area -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">
                        <i class="bi bi-robot"></i> AI Chat
                    </h6>
                    <small class="text-muted" id="chatStatus">Select a model to start chatting</small>
                </div>
                <div>
                    <span class="badge bg-success d-none" id="modelStatus">Ready</span>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="text-center py-5" id="welcomeMessage">
                    <i class="bi bi-robot" style="font-size: 4rem; color: #667eea; margin-bottom: 20px;"></i>
                    <h5>Welcome to HomeMade GPT Chat!</h5>
                    <p class="text-muted">
                        Select a trained model from the sidebar and start chatting with your custom AI.
                    </p>
                </div>
                
                <div id="messages"></div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator d-none" id="typingIndicator">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="ms-2">AI is thinking...</span>
                </div>
            </div>
            
            <div class="card-footer">
                <form id="chatForm">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" 
                               placeholder="Type your message here..." disabled>
                        <button type="submit" class="btn btn-gradient" id="sendBtn" disabled>
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        Press Enter to send ‚Ä¢ Shift+Enter for new line
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Models Available -->
<div class="row">
    <div class="col-12">
        <div class="card text-center">
            <div class="card-body py-5">
                <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #ffc107; margin-bottom: 20px;"></i>
                <h4>No Trained Models Available</h4>
                <p class="text-muted mb-4">
                    You need to train at least one model before you can start chatting.
                </p>
                <a href="{{ url_for('train_page') }}" class="btn btn-gradient btn-lg">
                    <i class="bi bi-plus-circle"></i> Train Your First Model
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
let selectedModel = null;
let chatHistory = [];
let isGenerating = false;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Update temperature display
    document.getElementById('temperature').addEventListener('input', function() {
        document.getElementById('tempValue').textContent = this.value;
    });
    
    // Update length display
    document.getElementById('maxLength').addEventListener('input', function() {
        document.getElementById('lengthValue').textContent = this.value;
    });
    
    // Model selection
    document.getElementById('modelSelect').addEventListener('change', function() {
        console.log('Model selection changed:', this.value);
        if (this.value) {
            console.log('Selecting model:', this.options[this.selectedIndex].text);
            selectModel(this.value, this.options[this.selectedIndex].text);
        } else {
            console.log('Deselecting model');
            deselectModel();
        }
    });
    
    // Chat form
    document.getElementById('chatForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Enter key handling
    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Auto-select model if provided in URL
    const urlParams = new URLSearchParams(window.location.search);
    const modelParam = urlParams.get('model');
    if (modelParam) {
        const select = document.getElementById('modelSelect');
        for (let option of select.options) {
            if (option.value.includes(modelParam)) {
                select.value = option.value;
                selectModel(option.value, option.text);
                break;
            }
        }
    }
});

function selectModel(modelPath, modelName) {
    console.log('selectModel called:', modelPath, modelName);
    selectedModel = modelPath;
    
    // Update UI
    document.getElementById('modelInfo').classList.remove('d-none');
    document.getElementById('modelName').textContent = modelName;
    document.getElementById('modelDetails').textContent = `Path: ${modelPath}`;
    document.getElementById('chatStatus').textContent = 'Model loaded - Ready to chat!';
    document.getElementById('modelStatus').classList.remove('d-none');
    
    // Enable chat input
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    console.log('Enabling input elements:', messageInput, sendBtn);
    messageInput.disabled = false;
    sendBtn.disabled = false;
    messageInput.focus();
    
    // Hide welcome message
    document.getElementById('welcomeMessage').style.display = 'none';
    
    // Show welcome chat message
    addMessage('assistant', `üëã Hi! I'm your custom AI trained on your data. What would you like to talk about?`);
}

function deselectModel() {
    selectedModel = null;
    
    // Update UI
    document.getElementById('modelInfo').classList.add('d-none');
    document.getElementById('chatStatus').textContent = 'Select a model to start chatting';
    document.getElementById('modelStatus').classList.add('d-none');
    
    // Disable chat input
    document.getElementById('messageInput').disabled = true;
    document.getElementById('sendBtn').disabled = true;
    
    // Show welcome message
    document.getElementById('welcomeMessage').style.display = 'block';
    document.getElementById('messages').innerHTML = '';
}

function sendMessage() {
    if (!selectedModel || isGenerating) return;
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    chatHistory.push({role: 'user', content: message});
    
    // Clear input
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Generate AI response
    generateResponse(message);
}

function generateResponse(message) {
    isGenerating = true;
    document.getElementById('sendBtn').disabled = true;
    
    const requestData = {
        model_path: selectedModel,
        message: message,
        temperature: parseFloat(document.getElementById('temperature').value),
        max_length: parseInt(document.getElementById('maxLength').value)
    };
    
    fetch('/chat_api', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        
        if (data.success) {
            const response = data.response || 'I apologize, but I couldn\'t generate a response.';
            addMessage('assistant', response);
            chatHistory.push({role: 'assistant', content: response});
        } else {
            addMessage('assistant', `‚ùå Error: ${data.error}`, 'error');
        }
        
        isGenerating = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('messageInput').focus();
    })
    .catch(error => {
        hideTypingIndicator();
        addMessage('assistant', `‚ùå Network error: ${error}`, 'error');
        isGenerating = false;
        document.getElementById('sendBtn').disabled = false;
    });
}

function addMessage(role, content, type = 'normal') {
    const messagesContainer = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    
    if (role === 'user') {
        messageDiv.className = 'message-user';
        messageDiv.innerHTML = `<strong>You:</strong><br>${escapeHtml(content)}`;
    } else {
        messageDiv.className = type === 'error' ? 'message-bot' : 'message-bot';
        if (type === 'error') {
            messageDiv.style.backgroundColor = '#ffebee';
            messageDiv.style.borderLeftColor = '#f44336';
        }
        messageDiv.innerHTML = `<strong>ü§ñ AI:</strong><br>${escapeHtml(content)}`;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').classList.remove('d-none');
    const container = document.getElementById('chatContainer');
    container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').classList.add('d-none');
}

function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        document.getElementById('messages').innerHTML = '';
        chatHistory = [];
        
        if (selectedModel) {
            addMessage('assistant', 'üëã Chat cleared! What would you like to talk about?');
        }
    }
}

function exportChat() {
    if (chatHistory.length === 0) {
        alert('No chat history to export.');
        return;
    }
    
    const chatText = chatHistory.map(msg => 
        `${msg.role === 'user' ? 'You' : 'AI'}: ${msg.content}`
    ).join('\n\n');
    
    const blob = new Blob([chatText], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat_history_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}
</script>
{% endblock %}
