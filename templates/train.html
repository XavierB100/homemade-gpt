{% extends "base.html" %}

{% block title %}Train Your Model - HomeMade GPT{% endblock %}

{% block extra_head %}
<style>
    .upload-zone {
        border: 3px dashed #667eea;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        background: rgba(102, 126, 234, 0.05);
        transition: all 0.3s ease;
    }
    
    .upload-zone.dragover {
        border-color: #38ef7d;
        background: rgba(56, 239, 125, 0.1);
        transform: scale(1.02);
    }
    
    .file-info {
        background: rgba(56, 239, 125, 0.1);
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #38ef7d;
    }
    
    .training-progress {
        display: none;
    }
    
    .training-progress.active {
        display: block;
    }
    
    .training-logs {
        background: #1a1a1a;
        color: #00ff00;
        border-radius: 10px;
        padding: 20px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-center mb-4">
            <i class="bi bi-mortarboard-fill feature-icon d-block"></i>
            Train Your AI Model
        </h1>
        <p class="text-center text-muted mb-5">
            Upload your text data and train a custom AI model. Supports books, WhatsApp chats, and any text format!
        </p>
    </div>
</div>

<!-- Upload Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-upload"></i> Step 1: Upload Training Data
                </h5>
            </div>
            <div class="card-body">
                <div class="upload-zone" id="uploadZone">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #667eea; margin-bottom: 20px;"></i>
                    <h5>Drop your text file here</h5>
                    <p class="text-muted mb-3">
                        Or click to browse files. Supports .txt files up to 16MB.
                    </p>
                    <button type="button" class="btn btn-gradient" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-folder2-open"></i> Choose File
                    </button>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                </div>
                
                <!-- File Info -->
                <div id="fileInfo" class="file-info mt-3" style="display: none;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1" id="fileName">📄 File Name</h6>
                            <p class="mb-0 text-muted" id="fileDetails">Size: 0 KB | Format: Unknown</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-danger" onclick="clearFile()">
                                <i class="bi bi-x-circle"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-sliders"></i> Step 2: Configure Training
                </h5>
            </div>
            <div class="card-body">
                <form id="trainingForm">
                    <div class="row">
                        <!-- Model Name -->
                        <div class="col-md-6 mb-3">
                            <label for="modelName" class="form-label">Model Name</label>
                            <input type="text" class="form-control" id="modelName" 
                                   placeholder="my-awesome-model" required>
                            <div class="form-text">Give your model a unique name</div>
                        </div>
                        
                        <!-- Model Size -->
                        <div class="col-md-6 mb-3">
                            <label for="modelSize" class="form-label">Model Size</label>
                            <select class="form-select" id="modelSize" required>
                                <option value="nano">Nano (0.8M params) - Quick experiments</option>
                                <option value="micro">Micro (1.5M params) - Small datasets</option>
                                <option value="tiny" selected>Tiny (10M params) - Recommended</option>
                                <option value="small">Small (25M params) - Better quality</option>
                                <option value="medium">Medium (70M params) - High quality</option>
                                <option value="large">Large (150M params) - Best quality (slow)</option>
                            </select>
                        </div>
                        
                        <!-- Training Iterations -->
                        <div class="col-md-6 mb-3">
                            <label for="maxIters" class="form-label">Training Iterations</label>
                            <input type="number" class="form-control" id="maxIters" 
                                   value="2000" min="100" max="20000" required>
                            <div class="form-text">More iterations = better quality (slower)</div>
                        </div>
                        
                        <!-- Learning Rate -->
                        <div class="col-md-6 mb-3">
                            <label for="learningRate" class="form-label">Learning Rate</label>
                            <select class="form-select" id="learningRate">
                                <option value="0.0001">0.0001 - Conservative</option>
                                <option value="0.0003" selected>0.0003 - Recommended</option>
                                <option value="0.001">0.001 - Aggressive</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings (Collapsible) -->
                    <div class="accordion mt-3">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSettings">
                                    <i class="bi bi-gear-fill me-2"></i> Advanced Settings
                                </button>
                            </h2>
                            <div id="advancedSettings" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="blockSize" class="form-label">Context Length</label>
                                            <select class="form-select" id="blockSize">
                                                <option value="128">128 - Fast training</option>
                                                <option value="256" selected>256 - Balanced</option>
                                                <option value="512">512 - Long context</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="batchSize" class="form-label">Batch Size</label>
                                            <select class="form-select" id="batchSize">
                                                <option value="16">16 - Low memory</option>
                                                <option value="32" selected>32 - Balanced</option>
                                                <option value="64">64 - Fast training</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="dropout" class="form-label">Dropout</label>
                                            <select class="form-select" id="dropout">
                                                <option value="0.0">0.0 - No regularization</option>
                                                <option value="0.1" selected>0.1 - Light regularization</option>
                                                <option value="0.2">0.2 - Strong regularization</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Start Training Button -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-gradient btn-lg" id="startTrainingBtn" disabled>
                            <i class="bi bi-play-fill"></i> Start Training
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Training Progress Section -->
<div class="row training-progress" id="trainingProgress">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-activity"></i> Training Progress
                </h5>
                <span class="badge bg-success" id="trainingStatus">Training...</span>
            </div>
            <div class="card-body">
                <!-- Progress Bar -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Progress</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Training Stats -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0" id="currentIteration">0</div>
                            <small class="text-muted">Iteration</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0" id="currentLoss">0.000</div>
                            <small class="text-muted">Current Loss</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0" id="bestLoss">0.000</div>
                            <small class="text-muted">Best Loss</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 mb-0" id="learningRateDisplay">0.000</div>
                            <small class="text-muted">Learning Rate</small>
                        </div>
                    </div>
                </div>
                
                <!-- Training Logs -->
                <div class="training-logs" id="trainingLogs">
                    <div>🚀 Initializing training...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tips Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightbulb"></i> Training Tips
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>📚 For Books/Novels:</h6>
                        <ul class="text-muted">
                            <li>Use at least 1MB of text (short book)</li>
                            <li>Recommended: Small or Medium model</li>
                            <li>Training iterations: 5000-10000</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>💬 For WhatsApp Chats:</h6>
                        <ul class="text-muted">
                            <li>Export chat without media</li>
                            <li>Recommended: Tiny or Small model</li>
                            <li>Training iterations: 2000-5000</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let uploadedFile = null;
let socket = null;

// Initialize Socket.IO connection
document.addEventListener('DOMContentLoaded', function() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Connected to server');
    });
    
    socket.on('training_progress', function(data) {
        updateTrainingProgress(data);
    });
    
    socket.on('training_complete', function(data) {
        onTrainingComplete(data);
    });
    
    socket.on('training_error', function(data) {
        onTrainingError(data);
    });
});

// File upload handling
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

// Drag and drop
uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', function() {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

// File input change
fileInput.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    if (!file.name.endsWith('.txt')) {
        alert('Please select a .txt file');
        return;
    }
    
    if (file.size > 16 * 1024 * 1024) {
        alert('File too large. Maximum size is 16MB.');
        return;
    }
    
    uploadFile(file);
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    // Show loading
    const fileName = document.getElementById('fileName');
    fileName.textContent = '📤 Uploading...';
    document.getElementById('fileInfo').style.display = 'block';
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            uploadedFile = data;
            showFileInfo(data);
            document.getElementById('startTrainingBtn').disabled = false;
        } else {
            alert('Upload failed: ' + data.message);
            clearFile();
        }
    })
    .catch(error => {
        alert('Upload error: ' + error);
        clearFile();
    });
}

function showFileInfo(data) {
    document.getElementById('fileName').textContent = `📄 ${data.filename}`;
    document.getElementById('fileDetails').textContent = 
        `Size: ${(data.size / 1024).toFixed(1)} KB | Format: ${data.metadata.format}`;
    document.getElementById('fileInfo').style.display = 'block';
}

function clearFile() {
    uploadedFile = null;
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('startTrainingBtn').disabled = true;
    fileInput.value = '';
}

// Training form handling
document.getElementById('trainingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!uploadedFile) {
        alert('Please upload a file first');
        return;
    }
    
    const config = {
        file_path: uploadedFile.file_path,
        data_type: 'auto',
        model_name: document.getElementById('modelName').value,
        model_size: document.getElementById('modelSize').value,
        max_iters: parseInt(document.getElementById('maxIters').value),
        learning_rate: parseFloat(document.getElementById('learningRate').value),
        block_size: parseInt(document.getElementById('blockSize').value),
        batch_size: parseInt(document.getElementById('batchSize').value),
        dropout: parseFloat(document.getElementById('dropout').value)
    };
    
    startTraining(config);
});

function startTraining(config) {
    fetch('/start_training', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showTrainingProgress();
        } else {
            alert('Training failed to start: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error starting training: ' + error);
    });
}

function showTrainingProgress() {
    document.getElementById('trainingProgress').classList.add('active');
    document.getElementById('startTrainingBtn').disabled = true;
    
    // Scroll to progress section
    document.getElementById('trainingProgress').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

function updateTrainingProgress(data) {
    document.getElementById('progressBar').style.width = data.progress + '%';
    document.getElementById('progressText').textContent = data.progress + '%';
    document.getElementById('currentIteration').textContent = data.iteration;
    document.getElementById('currentLoss').textContent = data.current_loss.toFixed(4);
    document.getElementById('bestLoss').textContent = data.best_loss.toFixed(4);
    document.getElementById('learningRateDisplay').textContent = data.lr.toExponential(2);
    
    // Add log entry
    const logs = document.getElementById('trainingLogs');
    const logEntry = document.createElement('div');
    logEntry.textContent = `[${new Date().toLocaleTimeString()}] Iteration ${data.iteration}: Loss ${data.current_loss.toFixed(4)}, Val Loss ${data.val_loss.toFixed(4)}`;
    logs.appendChild(logEntry);
    logs.scrollTop = logs.scrollHeight;
}

function onTrainingComplete(data) {
    document.getElementById('trainingStatus').textContent = 'Completed';
    document.getElementById('trainingStatus').className = 'badge bg-success';
    
    const logs = document.getElementById('trainingLogs');
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<strong style="color: #00ff00;">🎉 Training completed! Model "${data.model_name}" saved with final loss: ${data.final_loss.toFixed(4)}</strong>`;
    logs.appendChild(logEntry);
    logs.scrollTop = logs.scrollHeight;
    
    // Show success message and redirect option
    setTimeout(() => {
        if (confirm('Training completed successfully! Would you like to chat with your new model?')) {
            window.location.href = '/chat';
        }
    }, 2000);
}

function onTrainingError(data) {
    document.getElementById('trainingStatus').textContent = 'Error';
    document.getElementById('trainingStatus').className = 'badge bg-danger';
    
    const logs = document.getElementById('trainingLogs');
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<strong style="color: #ff0000;">❌ Training failed: ${data.error}</strong>`;
    logs.appendChild(logEntry);
    logs.scrollTop = logs.scrollHeight;
    
    document.getElementById('startTrainingBtn').disabled = false;
}
</script>
{% endblock %}
